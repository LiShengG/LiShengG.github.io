---
title: Raft协议
date: 2024-08-25 13:29:05
permalink: /pages/9ea153/
author: 
  name: lisheng
  link: https://github.com/LiShengG
---


# [raft](https://zhuanlan.zhihu.com/p/383555591)
## 1.1 三个子问题：

1. **Leader election**领导选举：
2. **Log replication**日志复制：
3. **Safety 安全性**：特殊 case，保证 Raft 算法的完备性；

所以，Raft 算法核心流程可以归纳为：

- 选出 leader，接收外部的数据更新/删除请求；
- 日志复制到其他 follower 节点
-  leader 故障，重新选举新 leader；
## **2.1 Leader Election**
集群中每个节点只能处于 Leader、Follower 和 Candidate 三种状态的一种:

1. **follower 从节点**：
1. **candidate 候选者**：
1. **leader 主节点**：
- 成为 leader 节点后，接受客户端的数据请求，负责日志同步；
- 遇到更高任期 Term 的 candidate 之前任期的 leader 转化为 follower，且投票；
- 遇到更高任期 Term 的 leader ，之前任期的 leader 转化为 follower；

具体的节点状态转换参考下图： 
![image.png](https://cdn.nlark.com/yuque/0/2024/png/32548312/1720221832744-afa207e2-67fc-4af9-b37c-84f86bbec1a1.png#averageHue=%23f6f6f6&clientId=u73ec2c27-fa11-4&from=paste&id=udfc89ee5&originHeight=291&originWidth=600&originalType=url&ratio=1.3499999046325684&rotation=0&showTitle=false&size=64877&status=done&style=none&taskId=ub496ea3d-bb3e-496b-9549-89ed16bd7e7&title=)

每个任期 Term 都有自TermId，全局唯一、单调递增。

## **2.2 Log Replication**[日志复制](https://www.zhihu.com/search?q=%E6%97%A5%E5%BF%97%E5%A4%8D%E5%88%B6&search_source=Entity&hybrid_search_source=Entity&hybrid_search_extra=%7B%22sourceType%22%3A%22article%22%2C%22sourceId%22%3A%22383555591%22%7D)
选举 leader 成功后，对外提供服务。Leader 接收客户端请求，转化为 log 复制命令，其他节点完成日志复制请求。每个日志复制请求包括状态机命令 & 任期号，同时还有前一个日志的任期号和日志索引。[状态机命令](https://www.zhihu.com/search?q=%E7%8A%B6%E6%80%81%E6%9C%BA%E5%91%BD%E4%BB%A4&search_source=Entity&hybrid_search_source=Entity&hybrid_search_extra=%7B%22sourceType%22%3A%22article%22%2C%22sourceId%22%3A%22383555591%22%7D)表示客户端请求的数据操作指令，任期号表示 leader 的当前任期。
follower 日志复制请求的处理流程：

1. follower 会使用前一个日志的任期号和日志索引来对比自己的数据：
- 如果相同，接收复制请求，回复 ok；
- 否则回拒绝复制当前日志，回复 error；
2. leader 收到拒绝复后，继续发送复制请求，带上更前面的日志term和index；
3. 循环，直到找到一个共同的任期号&日志索引。 follower 从这个索引值开始复制，最终和 leader 节点日志保持一致；
4. 超过半数节点复制日志成功， commite ；
## **2.3 Safety 安全性**
## **2.3.1 Election Safety 选举安全性：避免**[脑裂](https://www.zhihu.com/search?q=%E8%84%91%E8%A3%82&search_source=Entity&hybrid_search_source=Entity&hybrid_search_extra=%7B%22sourceType%22%3A%22article%22%2C%22sourceId%22%3A%22383555591%22%7D)**问题**
一个Term 内只能有一个 leader，投票原则：

- 一个term，follower 只会**投票一次票**，先来先得；
- Candidate 存储的日志至少要和 follower 一样新；
- 超过半数投票, 成为 leader；
## **2.3.2 Leader Append-Only 日志只能 leader 添加修改**
所有的数据请求都要交给 leader 节点处理，要求：

1. leader 只能日志追加日志，**不能覆盖日志**；
2. 只有 leader 的日志项才能被提交，follower 不能接收写请求和提交日志；
3. 只有已经提交的日志项，才能被应用到[状态机](https://www.zhihu.com/search?q=%E7%8A%B6%E6%80%81%E6%9C%BA&search_source=Entity&hybrid_search_source=Entity&hybrid_search_extra=%7B%22sourceType%22%3A%22article%22%2C%22sourceId%22%3A%22383555591%22%7D)中；
4. 选举时限制新 leader 日志包含所有已提交日志项；
## **2.3.3 Log Matching 日志匹配特性**
保证日志的唯一性，要求：

1. 相同索引和任期号，存储的命令是相同的；
2. 着相同索引和任期号，它们之间所有条目完全一样；
## **2.3.4 Leader Completeness ：leader 必须具备最新提交日志**
只**有拥有最新提交日志的 follower 节点才有资格成为 leader 节点**
> candidate 竞选投票时携带最新提交日志，follower 用自己日志和 candidate 做比较。

日志更新 比较日志项的 [term](https://www.zhihu.com/search?q=term&search_source=Entity&hybrid_search_source=Entity&hybrid_search_extra=%7B%22sourceType%22%3A%22article%22%2C%22sourceId%22%3A%22383555591%22%7D) 和 index：

- 如果 TermId 不同，选 TermId 最大的；
- 如果 TermId 相同，选 Index 最大的；
## **2.3.5 State Machine Safety ：确保当前任期日志提交**
Raft 日志提交有额外安全机制：leader 只能提交当前任期 Term 的日志，旧任期 Term（以前的数据）只能通过当前任期 Term 的数据提交来间接完成提交。简单的说，日志提交有两个条件需要满足：

1. **当前任期**；
2. [复制结点](https://www.zhihu.com/search?q=%E5%A4%8D%E5%88%B6%E7%BB%93%E7%82%B9&search_source=Entity&hybrid_search_source=Entity&hybrid_search_extra=%7B%22sourceType%22%3A%22article%22%2C%22sourceId%22%3A%22383555591%22%7D)**超过半数**；

